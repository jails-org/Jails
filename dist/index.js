(function(R,D){typeof exports=="object"&&typeof module!="undefined"?module.exports=D():typeof define=="function"&&define.amd?define(D):(R=typeof globalThis!="undefined"?globalThis:R||self,R.jails=D())})(this,function(){"use strict";const R=new DOMParser;function D(e,t,n){const r=new RegExp(`\\${t.tags[0]}(.+?)\\${t.tags[1]}`,"g"),i=R.parseFromString(e.replace(/<\/?template[^>]*>/g,""),"text/html");return i.querySelectorAll("[html-for], [html-if], [html-inner], [html-class]").forEach(a=>{const s=a.getAttribute("html-foreach"),h=a.getAttribute("html-for"),_=a.getAttribute("html-if"),m=a.getAttribute("html-inner"),S=a.getAttribute("html-class"),g=h||s;if(g){const T=h?"html-for":"html-foreach",y=g.match(/(.*)\sin\s(.*)/)||"",o=y[1],d=y[2];a.removeAttribute(T);const A=Array.from(a.querySelectorAll(`[tplid]:not([${T}] [tplid])`)).map(w=>{const P=w.getAttribute("tplid");return n[P]=[],P}),x=document.createTextNode(`%%_(function(){ var $index = 0; for(var $key in safe(function(){ return ${d} }) ){ var ${o} = ${d}[$key]; ${JSON.stringify(A).replace(/\"/g,"'")}.map(function(id){ if($scopes[id]) { $scopes[id][$index] = { ${o}: ${d}[$key], $index: $index, $key: $key } } }); _%%`),N=document.createTextNode("%%_ $index++}})() _%%");ne(x,a,N)}if(_){a.removeAttribute("html-if");const T=document.createTextNode(`%%_ if ( safe(function(){ return ${_} }) ){ _%%`),y=document.createTextNode("%%_ } _%%");ne(T,a,y)}m&&(a.removeAttribute("html-inner"),a.innerHTML=`%%_=${m}_%%`),S&&(a.removeAttribute("html-class"),a.className=(a.className+` %%_=${S}_%%`).trim())}),i.body.innerHTML.replace(r,"%%_=$1_%%").replace(/html-(allowfullscreen|async|autofocus|autoplay|checked|controls|default|defer|disabled|formnovalidate|inert|ismap|itemscope|loop|multiple|muted|nomodule|novalidate|open|playsinline|readonly|required|reversed|selected)=\"(.*?)\"/g,"%%_if(safe(function(){ return $2 })){_%%$1%%_}_%%").replace(/html-(.*?)=\"(.*?)\"/g,(a,s,h)=>s==="key"||s==="model"||s=="scope"?a:h?(h=h.replace(/^{|}$/g,""),`${s}="%%_=safe(function(){ return ${h} })_%%"`):a)}const ne=(e,t,n)=>{var r,i;(r=t.parentNode)==null||r.insertBefore(e,t),(i=t.parentNode)==null||i.insertBefore(n,t.nextSibling)},H=e=>requestAnimationFrame?requestAnimationFrame(e):setTimeout(e,1e3/60),_e=()=>"xxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*8|0;return(e=="x"?t:t&3|8).toString(8)}),B=e=>JSON.parse(JSON.stringify(e)),re=e=>{var t=e.attributes,n,r,i;if(t)for(n=t.length-1;n>=0;n-=1)i=t[n].name,typeof e[i]=="function"&&(e[i]=null);if(t=e.childNodes,t)for(r=t.length,n=0;n<r;n+=1)re(e.childNodes[n])},Ae=(e,t)=>{try{return e()}catch(n){return t||""}},ie=document.createElement("textarea"),ae={tags:["${","}"]},Te=e=>{Object.assign(ae,e)};function ye(e,t){const n=D(e.outerHTML,ae,t);ie.innerHTML=n;const r=JSON.stringify(ie.value);return new Function("$element","safe","$scopes",`
		var $data = this;
		with( $data ){
			var output=${r.replace(/%%_=(.+?)_%%/g,'"+safe(function(){return $1;})+"').replace(/%%_(.+?)_%%/g,`";$1
output+="`)};return output;
		}
	`)}const J=(e,t,n,r)=>Array.from(e.querySelectorAll("*")).filter(i=>i.tagName.toLowerCase()in t).reverse().map(i=>(Array.from(i.querySelectorAll("template")).map(a=>J(a.content,t,n,r)),xe(i,n,r),i)),xe=(e,t,n)=>{if(!e.getAttribute("tplid")){const i=_e();e.setAttribute("tplid",i),t[i]=ye(e,n)}};var se=11;function Se(e,t){var n=t.attributes,r,i,a,s,h;if(!(t.nodeType===se||e.nodeType===se)){for(var _=n.length-1;_>=0;_--)r=n[_],i=r.name,a=r.namespaceURI,s=r.value,a?(i=r.localName||i,h=e.getAttributeNS(a,i),h!==s&&(r.prefix==="xmlns"&&(i=r.name),e.setAttributeNS(a,i,s))):(h=e.getAttribute(i),h!==s&&e.setAttribute(i,s));for(var m=e.attributes,S=m.length-1;S>=0;S--)r=m[S],i=r.name,a=r.namespaceURI,a?(i=r.localName||i,t.hasAttributeNS(a,i)||e.removeAttributeNS(a,i)):t.hasAttribute(i)||e.removeAttribute(i)}}var V,Ne="http://www.w3.org/1999/xhtml",b=typeof document=="undefined"?void 0:document,we=!!b&&"content"in b.createElement("template"),$e=!!b&&b.createRange&&"createContextualFragment"in b.createRange();function Oe(e){var t=b.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}function Ee(e){V||(V=b.createRange(),V.selectNode(b.body));var t=V.createContextualFragment(e);return t.childNodes[0]}function Ce(e){var t=b.createElement("body");return t.innerHTML=e,t.childNodes[0]}function Ue(e){return e=e.trim(),we?Oe(e):$e?Ee(e):Ce(e)}function k(e,t){var n=e.nodeName,r=t.nodeName,i,a;return n===r?!0:(i=n.charCodeAt(0),a=r.charCodeAt(0),i<=90&&a>=97?n===r.toUpperCase():a<=90&&i>=97?r===n.toUpperCase():!1)}function Me(e,t){return!t||t===Ne?b.createElement(e):b.createElementNS(t,e)}function Le(e,t){for(var n=e.firstChild;n;){var r=n.nextSibling;t.appendChild(n),n=r}return t}function W(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var ce={OPTION:function(e,t){var n=e.parentNode;if(n){var r=n.nodeName.toUpperCase();r==="OPTGROUP"&&(n=n.parentNode,r=n&&n.nodeName.toUpperCase()),r==="SELECT"&&!n.hasAttribute("multiple")&&(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}W(e,t,"selected")},INPUT:function(e,t){W(e,t,"checked"),W(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var r=e.firstChild;if(r){var i=r.nodeValue;if(i==n||!n&&i==e.placeholder)return;r.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n=-1,r=0,i=e.firstChild,a,s;i;)if(s=i.nodeName&&i.nodeName.toUpperCase(),s==="OPTGROUP")a=i,i=a.firstChild;else{if(s==="OPTION"){if(i.hasAttribute("selected")){n=r;break}r++}i=i.nextSibling,!i&&a&&(i=a.nextSibling,a=null)}e.selectedIndex=n}}},F=1,ue=11,le=3,oe=8;function $(){}function Re(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}function De(e){return function(n,r,i){if(i||(i={}),typeof r=="string")if(n.nodeName==="#document"||n.nodeName==="HTML"||n.nodeName==="BODY"){var a=r;r=b.createElement("html"),r.innerHTML=a}else r=Ue(r);else r.nodeType===ue&&(r=r.firstElementChild);var s=i.getNodeKey||Re,h=i.onBeforeNodeAdded||$,_=i.onNodeAdded||$,m=i.onBeforeElUpdated||$,S=i.onElUpdated||$,g=i.onBeforeNodeDiscarded||$,T=i.onNodeDiscarded||$,y=i.onBeforeElChildrenUpdated||$,o=i.skipFromChildren||$,d=i.addChild||function(u,c){return u.appendChild(c)},A=i.childrenOnly===!0,x=Object.create(null),N=[];function w(u){N.push(u)}function P(u,c){if(u.nodeType===F)for(var p=u.firstChild;p;){var l=void 0;c&&(l=s(p))?w(l):(T(p),p.firstChild&&P(p,c)),p=p.nextSibling}}function q(u,c,p){g(u)!==!1&&(c&&c.removeChild(u),T(u),P(u,p))}function ge(u){if(u.nodeType===F||u.nodeType===ue)for(var c=u.firstChild;c;){var p=s(c);p&&(x[p]=c),ge(c),c=c.nextSibling}}ge(n);function Q(u){_(u);for(var c=u.firstChild;c;){var p=c.nextSibling,l=s(c);if(l){var f=x[l];f&&k(c,f)?(c.parentNode.replaceChild(f,c),G(f,c)):Q(c)}else Q(c);c=p}}function We(u,c,p){for(;c;){var l=c.nextSibling;(p=s(c))?w(p):q(c,u,!0),c=l}}function G(u,c,p){var l=s(c);l&&delete x[l],!(!p&&(m(u,c)===!1||(e(u,c),S(u),y(u,c)===!1)))&&(u.nodeName!=="TEXTAREA"?Ye(u,c):ce.TEXTAREA(u,c))}function Ye(u,c){var p=o(u),l=c.firstChild,f=u.firstChild,M,O,L,X,E;e:for(;l;){for(X=l.nextSibling,M=s(l);!p&&f;){if(L=f.nextSibling,l.isSameNode&&l.isSameNode(f)){l=X,f=L;continue e}O=s(f);var z=f.nodeType,C=void 0;if(z===l.nodeType&&(z===F?(M?M!==O&&((E=x[M])?L===E?C=!1:(u.insertBefore(E,f),O?w(O):q(f,u,!0),f=E):C=!1):O&&(C=!1),C=C!==!1&&k(f,l),C&&G(f,l)):(z===le||z==oe)&&(C=!0,f.nodeValue!==l.nodeValue&&(f.nodeValue=l.nodeValue))),C){l=X,f=L;continue e}O?w(O):q(f,u,!0),f=L}if(M&&(E=x[M])&&k(E,l))p||d(u,E),G(E,l);else{var te=h(l);te!==!1&&(te&&(l=te),l.actualize&&(l=l.actualize(u.ownerDocument||b)),d(u,l),Q(l))}l=X,f=L}We(u,f,O);var me=ce[u.nodeName];me&&me(u,c)}var v=n,K=v.nodeType,be=r.nodeType;if(!A){if(K===F)be===F?k(n,r)||(T(n),v=Le(n,Me(r.nodeName,r.namespaceURI))):v=r;else if(K===le||K===oe){if(be===K)return v.nodeValue!==r.nodeValue&&(v.nodeValue=r.nodeValue),v;v=r}}if(v===r)T(n);else{if(r.isSameNode&&r.isSameNode(v))return;if(G(v,r,A),N)for(var Z=0,Qe=N.length;Z<Qe;Z++){var ee=x[N[Z]];ee&&q(ee,ee.parentNode,!1)}}return!A&&v!==n&&n.parentNode&&(v.actualize&&(v=v.actualize(n.ownerDocument||b)),n.parentNode.replaceChild(v,n)),v}}var Fe=De(Se);const Pe=(()=>"CustomEvent"in window&&typeof window.CustomEvent=="function"?(e,t)=>new CustomEvent(e,t):(e,t)=>{const n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!0,!0,t),n})(),He=(e,t)=>function(n){const r=this,i=n.detail||{};e.__events[t].forEach(a=>{a.handler.apply(r,[n].concat(i.args))})},fe=(e,t)=>{e.__events[t]&&e.__events[t].listener&&(e.removeEventListener(t,e.__events[t].listener,t=="focus"||t=="blur"||t=="mouseenter"||t=="mouseleave"),delete e.__events[t])},Be=(e,t,n)=>function(r){const i=this,a=r.detail||{};let s=r.target;for(;s&&(s.matches(t)&&(r.delegateTarget=s,n.apply(i,[r].concat(a.args))),s!==e);)s=s.parentNode},Ve=(e,t,n,r)=>{if(e.__events=e.__events||{},e.__events[t]=e.__events[t]||[],!e.__events[t].length){const i=He(e,t);e.addEventListener(t,i,t=="focus"||t=="blur"||t=="mouseenter"||t=="mouseleave"),e.__events[t].listener=i}n.call?e.__events[t].push({handler:n,callback:n}):e.__events[t].push({handler:Be(e,n,r),callback:r})},ke=(e,t,n)=>{if(n&&e.__events[t]&&e.__events[t].length){var r=e.__events[t];e.__events[t]=e.__events[t].filter(function(i){return i.callback!=n}),e.__events[t].listener=r.listener,e.__events[t].length||fe(e,t)}else fe(e,t)},Y=(e,t,n)=>{e.dispatchEvent(Pe(t,{bubbles:!0,detail:n}))},U={},j={},je=(e,t)=>{j[e]=Object.assign({},j[e],t),U[e]&&U[e].forEach(n=>n(t))},Ie=(e,t)=>(U[e]=U[e]||[],U[e].push(t),e in j&&t(j[e]),()=>{U[e]=U[e].filter(n=>n!=t)});function qe(e,{module:t,dependencies:n,templates:r,components:i,$scopes:a}){const s=Ge(t);J(e,i,r,a);const h=e.getAttribute("html-model"),_=h?new Function(`return ${h}`)():{},m=e.getAttribute("tplid"),S=m?r[m]:null,g={data:t.model?B(t.model):{}},T=a[m]&&a[m].length?a[m].shift():{};g.data=Object.assign(T,g.data,_);const y={template:S,elm:e,dependencies:n,publish:je,subscribe:Ie,main(o){s.main=o},unmount(o){s.unmount=o},onupdate(o){s.onupdate=o},on(o,d,A){Ve(e,o,d,A)},off(o,d){ke(e,o,d)},trigger(o,d,A){d.constructor===String?Array.from(e.querySelectorAll(d)).forEach(x=>Y(x,o,{args:A})):Y(e,o,{args:d})},emit:(...o)=>{Y(e,o.shift(),{args:o})},state:{set(o){if(o.constructor===Function){const d=B(g.data);o(d),y.render(d)}else y.render(o);return new Promise(d=>H(A=>H(()=>d(g.data))))},get(){return B(g.data)},getRaw(){return g.data}},render(o=g.data){if(!document.body.contains(e))return;g.data=Object.assign(g.data,o);const d=B(g.data),A=y.template.call(s.view(d),e,Ae,a);Fe(e,A,Ke()),H(x=>{Array.from(e.querySelectorAll("[tplid]")).forEach(N=>{const w=Object.assign(N.base.state.getRaw(),d);N.options.onupdate(w),N.base.render(w)})})}};return{base:y,options:s}}const Ge=e=>({main:t=>t,unmount:t=>t,onupdate:t=>t,view:e.view?e.view:t=>t}),Ke=e=>({onNodeAdded:pe,onElUpdated:pe,onBeforeElChildrenUpdated:de,onBeforeElUpdated:de}),de=e=>{if("html-static"in e.attributes)return!1},pe=e=>e.nodeType===1&&e.getAttribute("tplid")?!1:e;function Xe(e,t,n,r,i){return class extends HTMLElement{constructor(){super();const{base:a,options:s}=qe(this,{module:e,dependencies:t,templates:n,components:r,$scopes:i});this.base=a,this.options=s,this.returns=e.default(a)}connectedCallback(){var a;this.base.render(),this.returns&&this.returns.constructor===Promise?this.returns.then(s=>{var h;this.base&&((h=this.options.main())==null||h.forEach(_=>_(this.base)))}):(a=this.options.main())==null||a.forEach(s=>s(this.base))}disconnectedCallback(){this.options.unmount(this.base),H(()=>{document.body.contains(this)||(this.__events&&(this.__events=null),this.base&&(this.base.elm=null),this.base&&(this.base=null),re(this))})}attributeChangedCallback(){}}}const he={},I={},ve={},ze={templateConfig:Te,register(e,t,n){I[e]={name:e,module:t,dependencies:n}},start(){const e=document.body;J(e,I,he,ve),Je()}},Je=()=>{Object.values(I).forEach(e=>{const{name:t,module:n,dependencies:r}=e,i=Xe(n,r,he,I,ve);customElements.define(t,i)})};return ze});
//# sourceMappingURL=index.js.map
