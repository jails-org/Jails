!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jails={})}(this,(function(e){"use strict";var t=Object.defineProperty,n=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,a=(e,n,r)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[n]=r,i=(e,t)=>{for(var i in t||(t={}))r.call(t,i)&&a(e,i,t[i]);if(n)for(var i of n(t))o.call(t,i)&&a(e,i,t[i]);return e};let l;const s={scope:{}},c=e=>(l=l||document.createElement("textarea"),l.innerHTML=e,l.value),u=()=>Math.random().toString(36).substring(2,9),d=(e,t)=>{try{return e()}catch(n){return t||""}};var f=function(){const e=()=>{},t={morphStyle:"outerHTML",callbacks:{beforeNodeAdded:e,afterNodeAdded:e,beforeNodeMorphed:e,afterNodeMorphed:e,beforeNodeRemoved:e,afterNodeRemoved:e,beforeAttributeUpdated:e},head:{style:"merge",shouldPreserve:e=>"true"===e.getAttribute("im-preserve"),shouldReAppend:e=>"true"===e.getAttribute("im-re-append"),shouldRemove:e,afterHeadMorphed:e},restoreFocus:!0};const n=function(){function e(e,t,n,o){if(!1===o.callbacks.beforeNodeAdded(t))return null;if(o.idMap.has(t)){const a=document.createElement(t.tagName);return e.insertBefore(a,n),r(a,t,o),o.callbacks.afterNodeAdded(a),a}{const r=document.importNode(t,!0);return e.insertBefore(r,n),o.callbacks.afterNodeAdded(r),r}}const t=function(){function e(e,t,n){let r=e.idMap.get(t),o=e.idMap.get(n);if(!o||!r)return!1;for(const a of r)if(o.has(a))return!0;return!1}function t(e,t){const n=e,r=t;return n.nodeType===r.nodeType&&n.tagName===r.tagName&&(!n.id||n.id===r.id)}return function(n,r,o,a){let i=null,l=r.nextSibling,s=0,c=o;for(;c&&c!=a;){if(t(c,r)){if(e(n,c,r))return c;null===i&&(n.idMap.has(c)||(i=c))}if(null===i&&l&&t(c,l)&&(s++,l=l.nextSibling,s>=2&&(i=void 0)),c.contains(document.activeElement))break;c=c.nextSibling}return i||null}}();function n(e,t){var n;if(e.idMap.has(t))i(e.pantry,t,null);else{if(!1===e.callbacks.beforeNodeRemoved(t))return;null==(n=t.parentNode)||n.removeChild(t),e.callbacks.afterNodeRemoved(t)}}function o(e,t,r){let o=t;for(;o&&o!==r;){let t=o;o=o.nextSibling,n(e,t)}return o}function a(e,t,n,r){const o=r.target.querySelector(`#${t}`)||r.pantry.querySelector(`#${t}`);return function(e,t){const n=e.id;for(;e=e.parentNode;){let r=t.idMap.get(e);r&&(r.delete(n),r.size||t.idMap.delete(e))}}(o,r),i(e,o,n),o}function i(e,t,n){if(e.moveBefore)try{e.moveBefore(t,n)}catch(r){e.insertBefore(t,n)}else e.insertBefore(t,n)}return function(i,l,s,c=null,u=null){l instanceof HTMLTemplateElement&&s instanceof HTMLTemplateElement&&(l=l.content,s=s.content),c||(c=l.firstChild);for(const n of s.childNodes){if(c&&c!=u){const e=t(i,n,c,u);if(e){e!==c&&o(i,c,e),r(e,n,i),c=e.nextSibling;continue}}if(n instanceof Element&&i.persistentIds.has(n.id)){const e=a(l,n.id,c,i);r(e,n,i),c=e.nextSibling;continue}const s=e(l,n,c,i);s&&(c=s.nextSibling)}for(;c&&c!=u;){const e=c;c=c.nextSibling,n(i,e)}}}(),r=function(){function e(e,n,r,o){const a=n[r];if(a!==e[r]){const i=t(r,e,"update",o);i||(e[r]=n[r]),a?i||e.setAttribute(r,""):t(r,e,"remove",o)||e.removeAttribute(r)}}function t(e,t,n,r){return!("value"!==e||!r.ignoreActiveValue||t!==document.activeElement)||!1===r.callbacks.beforeAttributeUpdated(e,t,n)}function r(e,t){return!!t.ignoreActiveValue&&e===document.activeElement&&e!==document.body}return function(a,i,l){return l.ignoreActive&&a===document.activeElement?null:(!1===l.callbacks.beforeNodeMorphed(a,i)||(a instanceof HTMLHeadElement&&l.head.ignore||(a instanceof HTMLHeadElement&&"morph"!==l.head.style?o(a,i,l):(!function(n,o,a){let i=o.nodeType;if(1===i){const i=n,l=o,s=i.attributes,c=l.attributes;for(const e of c)t(e.name,i,"update",a)||i.getAttribute(e.name)!==e.value&&i.setAttribute(e.name,e.value);for(let e=s.length-1;0<=e;e--){const n=s[e];if(n&&!l.hasAttribute(n.name)){if(t(n.name,i,"remove",a))continue;i.removeAttribute(n.name)}}r(i,a)||function(n,r,o){if(n instanceof HTMLInputElement&&r instanceof HTMLInputElement&&"file"!==r.type){let a=r.value,i=n.value;e(n,r,"checked",o),e(n,r,"disabled",o),r.hasAttribute("value")?i!==a&&(t("value",n,"update",o)||(n.setAttribute("value",a),n.value=a)):t("value",n,"remove",o)||(n.value="",n.removeAttribute("value"))}else if(n instanceof HTMLOptionElement&&r instanceof HTMLOptionElement)e(n,r,"selected",o);else if(n instanceof HTMLTextAreaElement&&r instanceof HTMLTextAreaElement){let e=r.value,a=n.value;if(t("value",n,"update",o))return;e!==a&&(n.value=e),n.firstChild&&n.firstChild.nodeValue!==e&&(n.firstChild.nodeValue=e)}}(i,l,a)}8!==i&&3!==i||n.nodeValue!==o.nodeValue&&(n.nodeValue=o.nodeValue)}(a,i,l),r(a,l)||n(l,a,i))),l.callbacks.afterNodeMorphed(a,i)),a)}}();function o(e,t,n){let r=[],o=[],a=[],i=[],l=new Map;for(const c of t.children)l.set(c.outerHTML,c);for(const c of e.children){let e=l.has(c.outerHTML),t=n.head.shouldReAppend(c),r=n.head.shouldPreserve(c);e||r?t?o.push(c):(l.delete(c.outerHTML),a.push(c)):"append"===n.head.style?t&&(o.push(c),i.push(c)):!1!==n.head.shouldRemove(c)&&o.push(c)}i.push(...l.values());let s=[];for(const c of i){let t=document.createRange().createContextualFragment(c.outerHTML).firstChild;if(!1!==n.callbacks.beforeNodeAdded(t)){if("href"in t&&t.href||"src"in t&&t.src){let e,n=new Promise((function(t){e=t}));t.addEventListener("load",(function(){e()})),s.push(n)}e.appendChild(t),n.callbacks.afterNodeAdded(t),r.push(t)}}for(const c of o)!1!==n.callbacks.beforeNodeRemoved(c)&&(e.removeChild(c),n.callbacks.afterNodeRemoved(c));return n.head.afterHeadMorphed(e,{added:r,kept:a,removed:o}),s}const a=function(){function e(){const e=document.createElement("div");return e.hidden=!0,document.body.insertAdjacentElement("afterend",e),e}function n(e){let t=Array.from(e.querySelectorAll("[id]"));return e.id&&t.push(e),t}function r(e,t,n,r){for(const o of r)if(t.has(o.id)){let t=o;for(;t;){let r=e.get(t);if(null==r&&(r=new Set,e.set(t,r)),r.add(o.id),t===n)break;t=t.parentElement}}}return function(o,a,i){const{persistentIds:l,idMap:s}=function(e,t){const o=n(e),a=n(t),i=function(e,t){let n=new Set,r=new Map;for(const{id:a,tagName:i}of e)r.has(a)?n.add(a):r.set(a,i);let o=new Set;for(const{id:a,tagName:i}of t)o.has(a)?n.add(a):r.get(a)===i&&o.add(a);for(const a of n)o.delete(a);return o}(o,a);let l=new Map;r(l,i,e,o);const s=t.__idiomorphRoot||t;return r(l,i,s,a),{persistentIds:i,idMap:l}}(o,a),c=function(e){let n=Object.assign({},t);return Object.assign(n,e),n.callbacks=Object.assign({},t.callbacks,e.callbacks),n.head=Object.assign({},t.head,e.head),n}(i),u=c.morphStyle||"outerHTML";if(!["innerHTML","outerHTML"].includes(u))throw`Do not understand how to morph style ${u}`;return{target:o,newContent:a,config:c,morphStyle:u,ignoreActive:c.ignoreActive,ignoreActiveValue:c.ignoreActiveValue,restoreFocus:c.restoreFocus,idMap:s,persistentIds:l,pantry:e(),callbacks:c.callbacks,head:c.head}}}(),{normalizeElement:i,normalizeParent:l}=function(){const e=new WeakSet;return{normalizeElement:function(e){return e instanceof Document?e.documentElement:e},normalizeParent:function t(n){if(null==n)return document.createElement("div");if("string"==typeof n)return t(function(t){let n=new DOMParser,r=t.replace(/<svg(\s[^>]*>|>)([\s\S]*?)<\/svg>/gim,"");if(r.match(/<\/html>/)||r.match(/<\/head>/)||r.match(/<\/body>/)){let o=n.parseFromString(t,"text/html");if(r.match(/<\/html>/))return e.add(o),o;{let t=o.firstChild;return t&&e.add(t),t}}{let r=n.parseFromString("<body><template>"+t+"</template></body>","text/html").body.querySelector("template").content;return e.add(r),r}}(n));if(e.has(n))return n;if(n instanceof Node){if(n.parentNode)return function(e){return{childNodes:[e],querySelectorAll:t=>{const n=e.querySelectorAll(t);return e.matches(t)?[e,...n]:n},insertBefore:(t,n)=>e.parentNode.insertBefore(t,n),moveBefore:(t,n)=>e.parentNode.moveBefore(t,n),get __idiomorphRoot(){return e}}}(n);{const e=document.createElement("div");return e.append(n),e}}{const e=document.createElement("div");for(const t of[...n])e.append(t);return e}}}}();return{morph:function(e,t,r={}){e=i(e);const s=l(t),c=a(e,s,r),u=function(e,t){var n;if(!e.config.restoreFocus)return t();let r=document.activeElement;if(!(r instanceof HTMLInputElement||r instanceof HTMLTextAreaElement))return t();const{id:o,selectionStart:a,selectionEnd:i}=r,l=t();o&&o!==(null==(n=document.activeElement)?void 0:n.id)&&(r=e.target.querySelector(`#${o}`),null==r||r.focus());r&&!r.selectionEnd&&i&&r.setSelectionRange(a,i);return l}(c,(()=>function(e,t,n,r){if(e.head.block){const a=t.querySelector("head"),i=n.querySelector("head");if(a&&i){const t=o(a,i,e);return Promise.all(t).then((()=>{const t=Object.assign(e,{head:{block:!1,ignore:!0}});return r(t)}))}}return r(e)}(c,e,s,(t=>"innerHTML"===t.morphStyle?(n(t,e,s),Array.from(e.childNodes)):function(e,t,r){const o=l(t);let a=Array.from(o.childNodes);const i=a.indexOf(t),s=a.length-(i+1);return n(e,o,r,t,t.nextSibling),a=Array.from(o.childNodes),a.slice(i,a.length-s)}(t,e,s)))));return c.pantry.remove(),u},defaults:t}}();const m={},p={},h=(e,t)=>{p[e]=Object.assign({},p[e],t),m[e]&&m[e].forEach((e=>e(t)))},b=(e,t)=>(m[e]=m[e]||[],m[e].push(t),e in p&&t(p[e]),()=>{m[e]=m[e].filter((e=>e!=t))}),g=({name:e,module:t,dependencies:n,node:r,templates:o,signal:a,register:l})=>{var c;let u,m=[],p=null,g=[];const y=t.model||{},E=new Function(`return ${r.getAttribute("html-model")||"{}"}`)(),A=r.getAttribute("tplid"),N=r.getAttribute("html-scopeid"),T=o[A],M=s.scope[N],_=(S=(null==(c=null==t?void 0:t.model)?void 0:c.apply)?y({elm:r,initialState:E}):y,JSON.parse(JSON.stringify(S)));var S;const L=Object.assign({},M,_,E),$=t.view?t.view:e=>e,k={name:e,model:_,elm:r,template:T.template,dependencies:n,publish:h,subscribe:b,main(e){r.addEventListener(":mount",e)},state:{protected(e){if(!e)return m;m=e},save(e){e.constructor===Function?e(L):Object.assign(L,e)},set(e){if(!document.body.contains(r))return;e.constructor===Function?e(L):Object.assign(L,e);const t=Object.assign({},L,M);return new Promise((e=>{w(t,(()=>e(t)))}))},get:()=>Object.assign({},L)},dataset(e,t){const n=t||e,o=(t?e:r).dataset[n];if("true"===o)return!0;if("false"===o)return!1;if(!isNaN(o)&&""!==o.trim())return Number(o);try{return new Function("return ("+o+")")()}catch(a){}try{return JSON.parse(o)}catch(a){}return o},on(e,t,n){const o=e.match(/\[(.*)\]/);if(o)return g.push({target:n?t:null,callback:n||t}),void(p||(p=new MutationObserver((e=>{for(const t of e)if("attributes"===t.type){const e=t.attributeName;e===o[1]&&g.forEach((n=>{(n.target?r.querySelectorAll(n.target):[r]).forEach((r=>{r==t.target&&n.callback({target:t.target,attribute:e,value:t.target.getAttribute(e)})}))}))}})),p.observe(r,{attributes:!0,subtree:!0}),r.addEventListener(":unmount",(()=>{g=[],p.disconnect()}))));n?(n.handler=e=>{const o=e.detail||{};let a=e.target;for(;a&&(a.matches(t)&&(e.delegateTarget=a,n.apply(r,[e].concat(o.args))),a!==r);)a=a.parentNode},r.addEventListener(e,n.handler,{signal:a,capture:"focus"==e||"blur"==e||"mouseenter"==e||"mouseleave"==e})):(t.handler=e=>{e.delegateTarget=r,t.apply(r,[e].concat(e.detail.args))},r.addEventListener(e,t.handler,{signal:a}))},off(e,t){t.handler&&r.removeEventListener(e,t.handler)},trigger(e,t,n){t.constructor===String?Array.from(r.querySelectorAll(t)).forEach((t=>{t.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{args:n}}))})):r.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{args:n}}))},emit(e,t){r.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{args:t}}))},unmount(e){r.addEventListener(":unmount",e)},innerHTML(e,t){const n=t?e:r,o=n.cloneNode(),a=t||e;o.innerHTML=a,f.morph(n,o)}},w=(e,t=()=>{})=>{clearTimeout(u),u=setTimeout((()=>{const n=T.render.call(i(i({},e),$(e)),r,d,s);f.morph(r,n,v(r,l)),Promise.resolve().then((()=>{r.querySelectorAll("[tplid]").forEach((t=>{const n=l.get(t);n&&(n.state.protected().forEach((t=>delete e[t])),n.state.set(e))})),Promise.resolve().then((()=>{s.scope={},t()}))}))}))};return w(L),l.set(r,k),t.default(k)},v=(e,t)=>({callbacks:{beforeNodeMorphed(n){if(1===n.nodeType){if("html-static"in n.attributes)return!1;if(t.get(n)&&n!==e)return!1}}}}),y=new WeakMap,E=({component:e,templates:t,start:n})=>{const{name:r,module:o,dependencies:a}=e;return class extends HTMLElement{constructor(){super()}connectedCallback(){this.abortController=new AbortController,this.getAttribute("tplid")||n(this.parentNode);const e=g({node:this,name:r,module:o,dependencies:a,templates:t,signal:this.abortController.signal,register:y});e&&e.constructor===Promise?e.then((()=>{this.dispatchEvent(new CustomEvent(":mount"))})):this.dispatchEvent(new CustomEvent(":mount"))}disconnectedCallback(){this.dispatchEvent(new CustomEvent(":unmount")),this.abortController.abort()}}},A={tags:["{{","}}"]},N={},T=/html-(allowfullscreen|async|autofocus|autoplay|checked|controls|default|defer|disabled|formnovalidate|inert|ismap|itemscope|loop|multiple|muted|nomodule|novalidate|open|playsinline|readonly|required|reversed|selected)="(.*?)"/g,M=/html-([^\s]*?)="(.*?)"/g,_=e=>{const t=JSON.stringify(e);return new Function("$element","safe","$g",`\n\t\tvar $data = this;\n\t\twith( $data ){\n\t\t\tvar output=${t.replace(/%%_=(.+?)_%%/g,(function(e,t){return'"+safe(function(){return '+c(t)+';})+"'})).replace(/%%_(.+?)_%%/g,(function(e,t){return'";'+c(t)+'\noutput+="'}))};return output;\n\t\t}\n\t`)},S=(e,t,n)=>{const r=t.join(",");e.querySelectorAll(r).forEach((e=>{"template"!==e.localName?(e.hasAttribute("html-if")&&!e.id&&(e.id=u()),e.localName in n&&e.setAttribute("tplid",u())):S(e.content,t,n)}))},L=e=>e.replace(/jails___scope-id/g,"%%_=$scopeid_%%").replace(new RegExp(`\\${A.tags[0]}(.+?)\\${A.tags[1]}`,"g"),"%%_=$1_%%").replace(T,"%%_if(safe(function(){ return $2 })){_%%$1%%_}_%%").replace(M,((e,t,n)=>["key","model","scopeid"].includes(t)?e:n?`${t}="%%_=safe(function(){ return ${n=n.replace(/^{|}$/g,"")} })_%%"`:e)),$=e=>{e.querySelectorAll("template, [html-for], [html-if], [html-inner], [html-class]").forEach((e=>{const t=e.getAttribute("html-for"),n=e.getAttribute("html-if"),r=e.getAttribute("html-inner"),o=e.getAttribute("html-class");if(t){e.removeAttribute("html-for");const n=t.match(/(.*)\sin\s(.*)/)||"",r=n[1],o=n[2],a=o.split(/\./).shift(),i=document.createTextNode(`%%_ ;(function(){ var $index = 0; for(var $key in safe(function(){ return ${o} }) ){ var $scopeid = Math.random().toString(36).substring(2, 9); var ${r} = ${o}[$key]; $g.scope[$scopeid] = Object.assign({}, { ${a}: ${a} }, { ${r} :${r}, $index: $index, $key: $key }); _%%`),l=document.createTextNode("%%_ $index++; } })() _%%");H(i,e,l)}if(n){e.removeAttribute("html-if");const t=document.createTextNode(`%%_ if ( safe(function(){ return ${n} }) ){ _%%`),r=document.createTextNode("%%_ }  _%%");H(t,e,r)}r&&(e.removeAttribute("html-inner"),e.innerHTML=`%%_=${r}_%%`),o&&(e.removeAttribute("html-class"),e.className=(e.className+` %%_=${o}_%%`).trim()),"template"===e.localName&&$(e.content)}))},k=(e,t)=>{Array.from(e.querySelectorAll("[tplid]")).reverse().forEach((e=>{const n=e.getAttribute("tplid"),r=e.localName;if(e.setAttribute("html-scopeid","jails___scope-id"),r in t&&t[r].module.template){const n=e.innerHTML,o=t[r].module.template({elm:e,children:n});e.innerHTML=o,$(e),w(e)}const o=L(e.outerHTML);N[n]={template:o,render:_(o)}}))},w=e=>{const t=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>"TEMPLATE"===e.tagName?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}),n=[];for(;t.nextNode();){const e=t.currentNode;e.hasAttribute("html-if")||e.hasAttribute("html-inner")||n.push(e)}for(const r of n){const e=r.parentNode;if(!e)continue;const t=document.createDocumentFragment();t.append(...r.content.childNodes),e.replaceChild(t,r)}},H=(e,t,n)=>{var r,o;null==(r=t.parentNode)||r.insertBefore(e,t),null==(o=t.parentNode)||o.insertBefore(n,t.nextSibling)};globalThis.__jails__=globalThis.__jails__||{components:{}};const x=e=>{if("undefined"==typeof window)return;e=e||document.body;const{components:t}=globalThis.__jails__,n=((e,{components:t})=>{S(e,[...Object.keys(t),"[html-if]","template"],t);const n=e.cloneNode(!0);return $(n),w(n),k(n,t),N})(e,{components:t});Object.values(t).forEach((({name:e,module:t,dependencies:r})=>{customElements.get(e)||customElements.define(e,E({component:{name:e,module:t,dependencies:r},templates:n,start:x}))}))};e.publish=h,e.register=(e,t,n)=>{const{components:r}=globalThis.__jails__;r[e]={name:e,module:t,dependencies:n}},e.start=x,e.subscribe=b,e.templateConfig=e=>{var t;t=e,Object.assign(A,t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
//# sourceMappingURL=jails.js.map
