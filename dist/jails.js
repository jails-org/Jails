!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jails={})}(this,(function(e){"use strict";const t=document.createElement("textarea"),n=e=>(t.innerHTML=e,t.value),r=e=>requestAnimationFrame?requestAnimationFrame(e):setTimeout(e,1e3/60),o=()=>"xxxxxxxx".replace(/[xy]/g,(e=>{const t=8*Math.random()|0;return("x"==e?t:3&t|8).toString(8)})),i=e=>JSON.parse(JSON.stringify(e)),l=e=>{var t,n,r,o=e.attributes;if(o)for(t=o.length-1;t>=0;t-=1)"function"==typeof e[r=o[t].name]&&(e[r]=null);if(o=e.childNodes)for(n=o.length,t=0;t<n;t+=1)l(e.childNodes[t])},a=(e,t)=>{try{return e()}catch(n){return t||""}},s=new DOMParser;const c=(e,t,n)=>{var r,o;null==(r=t.parentNode)||r.insertBefore(e,t),null==(o=t.parentNode)||o.insertBefore(n,t.nextSibling)},u={tags:["${","}"]};function d(e){const t=function(e,t){const n=new RegExp(`\\${t.tags[0]}(.+?)\\${t.tags[1]}`,"g"),r=s.parseFromString(e.replace(/<\/?template[^>]*>/g,""),"text/html");return r.querySelectorAll("[html-for], [html-if], [html-inner], [html-class], [html-model]").forEach((e=>{const t=e.getAttribute("html-foreach"),n=e.getAttribute("html-for"),r=e.getAttribute("html-if"),i=e.getAttribute("html-inner"),l=e.getAttribute("html-class"),a=n||t;if(a){const t=n?"html-for":"html-foreach",r=a.match(/(.*)\sin\s(.*)/)||"",o=r[1],i=r[2];e.removeAttribute(t),e.setAttribute("scope","");const l=document.createElement("script");l.dataset.scope="",l.type="text/html",l.text="%%_= $scope _%%",e.appendChild(l);const s=document.createTextNode(`%%_(function(){ var $index = 0; for(var $key in safe(function(){ return ${i} }) ){ var ${o} = ${i}[$key]; var $scope = JSON.stringify({ '${o}':${o}, $index: $index, $key:$key }); _%%`),u=document.createTextNode("%%_ $index++; } })() _%%");c(s,e,u)}if(r){e.removeAttribute("html-if");const t=document.createTextNode(`%%_ if ( safe(function(){ return ${r} }) ){ _%%`),n=document.createTextNode("%%_ } _%%");c(t,e,n),e.id||e.setAttribute("id",`tplifid-${o()}`)}i&&(e.removeAttribute("html-inner"),e.innerHTML=`%%_=${i}_%%`),l&&(e.removeAttribute("html-class"),e.className=(e.className+` %%_=${l}_%%`).trim())})),r.body.innerHTML.replace(n,"%%_=$1_%%").replace(/html-(allowfullscreen|async|autofocus|autoplay|checked|controls|default|defer|disabled|formnovalidate|inert|ismap|itemscope|loop|multiple|muted|nomodule|novalidate|open|playsinline|readonly|required|reversed|selected)=\"(.*?)\"/g,"%%_if(safe(function(){ return $2 })){_%%$1%%_}_%%").replace(/html-(.*?)=\"(.*?)\"/g,((e,t,n)=>"key"===t||"model"===t||"scope"==t?e:n?`${t}="%%_=safe(function(){ return ${n=n.replace(/^{|}$/g,"")} })_%%"`:e))}(e.outerHTML,u),r=JSON.stringify(t);return new Function("$element","safe",`\n\t\tvar $data = this;\n\t\twith( $data ){\n\t\t\tvar output=${r.replace(/%%_=(.+?)_%%/g,(function(e,t){return'"+safe(function(){return '+n(t)+';})+"'})).replace(/%%_(.+?)_%%/g,(function(e,t){return'";'+n(t)+'\noutput+="'}))};return output;\n\t\t}\n\t`)}const f=(e,t,n,r)=>{[].concat(e.matches&&e.matches(t)?e:[]).concat(Array.from(e.querySelectorAll(t))).reverse().forEach((e=>{e.querySelectorAll("template").forEach((e=>f(e.content,t,n,r))),m(e,n,r)}))},m=(e,t,n)=>{if(!e.getAttribute("tplid")){const r=o();e.setAttribute("tplid",r);const i=e.localName;if(i in n&&n[i].module.template){const o=e.innerHTML,l=n[i].module.template({children:o});l.constructor===Promise?(e.__template=l,l.then((n=>{e.innerHTML=n,t[r]=d(e)}))):e.innerHTML=l}t[r]=d(e)}},h={},p={},b=(e,t)=>{p[e]=Object.assign({},p[e],t),h[e]&&h[e].forEach((e=>e(t)))},v=(e,t)=>(h[e]=h[e]||[],h[e].push(t),e in p&&t(p[e]),()=>{h[e]=h[e].filter((e=>e!=t))});var g=function(){let e=new Set,t={morphStyle:"outerHTML",callbacks:{beforeNodeAdded:u,afterNodeAdded:u,beforeNodeMorphed:u,afterNodeMorphed:u,beforeNodeRemoved:u,afterNodeRemoved:u,beforeAttributeUpdated:u,beforeNodePantried:u},head:{style:"merge",shouldPreserve:function(e){return"true"===e.getAttribute("im-preserve")},shouldReAppend:function(e){return"true"===e.getAttribute("im-re-append")},shouldRemove:u,afterHeadMorphed:u}};function n(e,t,r){var l,a;if(r.head.block){let o=e.querySelector("head"),i=t.querySelector("head");if(o&&i){let l=c(i,o,r);return void Promise.all(l).then((function(){n(e,t,Object.assign(r,{head:{block:!1,ignore:!0}}))}))}}if("innerHTML"===r.morphStyle)return i(t,e,r),r.config.twoPass&&A(e,r),Array.from(e.children);if("outerHTML"!==r.morphStyle&&null!=r.morphStyle)throw"Do not understand how to morph style "+r.morphStyle;{let n=function(e,t,n){let r;r=e.firstChild;let o=r,i=0;for(;r;){let e=g(r,t,n);e>i&&(o=r,i=e),r=r.nextSibling}return o}(t,e,r),i=null!=(l=null==n?void 0:n.previousSibling)?l:null,s=null!=(a=null==n?void 0:n.nextSibling)?a:null,c=o(e,n,r);if(!n)return[];if(c){const e=function(e,t,n){var r,o;let i=[],l=[];for(;null!=e;)i.push(e),e=e.previousSibling;let a=i.pop();for(;void 0!==a;)l.push(a),null==(r=t.parentElement)||r.insertBefore(a,t),a=i.pop();l.push(t);for(;null!=n;)i.push(n),l.push(n),n=n.nextSibling;for(;i.length>0;){const e=i.pop();null==(o=t.parentElement)||o.insertBefore(e,t.nextSibling)}return l}(i,c,s);return r.config.twoPass&&A(c.parentNode,r),e}}}function r(e,t){return!!t.ignoreActiveValue&&e===document.activeElement&&e!==document.body}function o(e,t,n){var o,l;return n.ignoreActive&&e===document.activeElement?null:null==t?!1===n.callbacks.beforeNodeRemoved(e)?e:(null==(o=e.parentNode)||o.removeChild(e),n.callbacks.afterNodeRemoved(e),null):m(e,t)?(!1===n.callbacks.beforeNodeMorphed(e,t)||(e instanceof HTMLHeadElement&&n.head.ignore||(e instanceof HTMLHeadElement&&"morph"!==n.head.style?c(t,e,n):(a(t,e,n),r(e,n)||i(t,e,n))),n.callbacks.afterNodeMorphed(e,t)),e):!1===n.callbacks.beforeNodeRemoved(e)||!1===n.callbacks.beforeNodeAdded(t)?e:(null==(l=e.parentNode)||l.replaceChild(t,e),n.callbacks.afterNodeAdded(t),n.callbacks.afterNodeRemoved(e),t)}function i(e,t,n){e instanceof HTMLTemplateElement&&t instanceof HTMLTemplateElement&&(e=e.content,t=t.content);let r,i=e.firstChild,l=t.firstChild;for(;i;){if(r=i,i=r.nextSibling,null==l){if(n.config.twoPass&&n.persistentIds.has(r.id))t.appendChild(r);else{if(!1===n.callbacks.beforeNodeAdded(r))continue;t.appendChild(r),n.callbacks.afterNodeAdded(r)}S(n,r);continue}if(f(r,l,n)){o(l,r,n),l=l.nextSibling,S(n,r);continue}let a=p(e,t,r,l,n);if(a){l=h(l,a,n),o(a,r,n),S(n,r);continue}let s=b(e,t,r,l,n);if(s)l=h(l,s,n),o(s,r,n),S(n,r);else{if(n.config.twoPass&&n.persistentIds.has(r.id))t.insertBefore(r,l);else{if(!1===n.callbacks.beforeNodeAdded(r))continue;t.insertBefore(r,l),n.callbacks.afterNodeAdded(r)}S(n,r)}}for(;null!==l;){let e=l;l=l.nextSibling,_(e,n)}}function l(e,t,n,r){return!("value"!==e||!r.ignoreActiveValue||t!==document.activeElement)||!1===r.callbacks.beforeAttributeUpdated(e,t,n)}function a(e,t,n){let o=e.nodeType;if(1===o){const r=e,o=t,i=r.attributes,a=o.attributes;for(const e of i)l(e.name,o,"update",n)||o.getAttribute(e.name)!==e.value&&o.setAttribute(e.name,e.value);for(let e=a.length-1;0<=e;e--){const t=a[e];if(t&&!r.hasAttribute(t.name)){if(l(t.name,o,"remove",n))continue;o.removeAttribute(t.name)}}}8!==o&&3!==o||t.nodeValue!==e.nodeValue&&(t.nodeValue=e.nodeValue),r(t,n)||function(e,t,n){if(e instanceof HTMLInputElement&&t instanceof HTMLInputElement&&"file"!==e.type){let r=e.value,o=t.value;s(e,t,"checked",n),s(e,t,"disabled",n),e.hasAttribute("value")?r!==o&&(l("value",t,"update",n)||(t.setAttribute("value",r),t.value=r)):l("value",t,"remove",n)||(t.value="",t.removeAttribute("value"))}else if(e instanceof HTMLOptionElement&&t instanceof HTMLOptionElement)s(e,t,"selected",n);else if(e instanceof HTMLTextAreaElement&&t instanceof HTMLTextAreaElement){let r=e.value,o=t.value;if(l("value",t,"update",n))return;r!==o&&(t.value=r),t.firstChild&&t.firstChild.nodeValue!==r&&(t.firstChild.nodeValue=r)}}(e,t,n)}function s(e,t,n,r){if(!(e instanceof Element&&t instanceof Element))return;const o=e[n];if(o!==t[n]){let i=l(n,t,"update",r);i||(t[n]=e[n]),o?i||t.setAttribute(n,o):l(n,t,"remove",r)||t.removeAttribute(n)}}function c(e,t,n){let r=[],o=[],i=[],l=[],a=n.head.style,s=new Map;for(const u of e.children)s.set(u.outerHTML,u);for(const u of t.children){let e=s.has(u.outerHTML),t=n.head.shouldReAppend(u),r=n.head.shouldPreserve(u);e||r?t?o.push(u):(s.delete(u.outerHTML),i.push(u)):"append"===a?t&&(o.push(u),l.push(u)):!1!==n.head.shouldRemove(u)&&o.push(u)}l.push(...s.values());let c=[];for(const u of l){let e=document.createRange().createContextualFragment(u.outerHTML).firstChild;if(!1!==n.callbacks.beforeNodeAdded(e)){if("href"in e&&e.href||"src"in e&&e.src){let t,n=new Promise((function(e){t=e}));e.addEventListener("load",(function(){t()})),c.push(n)}t.appendChild(e),n.callbacks.afterNodeAdded(e),r.push(e)}}for(const u of o)!1!==n.callbacks.beforeNodeRemoved(u)&&(t.removeChild(u),n.callbacks.afterNodeRemoved(u));return n.head.afterHeadMorphed(t,{added:r,kept:i,removed:o}),c}function u(){}function d(){const e=document.createElement("div");return e.hidden=!0,document.body.insertAdjacentElement("afterend",e),e}function f(e,t,n){return null!=e&&null!=t&&(e instanceof Element&&t instanceof Element&&e.tagName===t.tagName&&(""!==e.id&&e.id===t.id||k(n,e,t)>0))}function m(e,t){return null!=e&&null!=t&&((!e.id||e.id===t.id)&&(e.nodeType===t.nodeType&&e.tagName===t.tagName))}function h(e,t,n){let r=e;for(;r!==t;){let e=r;r=e.nextSibling,_(e,n)}return S(n,t),t.nextSibling}function p(e,t,n,r,o){let i=k(o,n,t),l=null;if(i>0){l=r;let t=0;for(;null!=l;){if(f(n,l,o))return l;if(t+=k(o,l,e),t>i)return null;l=l.nextSibling}}return l}function b(e,t,n,r,o){let i=r,l=n.nextSibling,a=0;for(;null!=i;){if(k(o,i,e)>0)return null;if(m(i,n))return i;if(m(i,l)&&(a++,l=l.nextSibling,a>=2))return null;i=i.nextSibling}return i}const v=new WeakSet;function g(e,t,n){return m(t,e)?.5+k(n,e,t):0}function _(t,n){var r;if(S(n,t),n.config.twoPass&&function(t,n){for(const r of t.idMap.get(n)||e)if(t.persistentIds.has(r))return!0;return!1}(n,t)&&t instanceof Element)y(t,n);else{if(!1===n.callbacks.beforeNodeRemoved(t))return;null==(r=t.parentNode)||r.removeChild(t),n.callbacks.afterNodeRemoved(t)}}function y(e,t){var n;if(!1!==t.callbacks.beforeNodePantried(e))if(Array.from(e.childNodes).forEach((e=>{y(e,t)})),t.persistentIds.has(e.id))t.pantry.moveBefore?t.pantry.moveBefore(e,null):t.pantry.insertBefore(e,null);else{if(!1===t.callbacks.beforeNodeRemoved(e))return;null==(n=e.parentNode)||n.removeChild(e),t.callbacks.afterNodeRemoved(e)}}function A(e,t){e instanceof Element&&(Array.from(t.pantry.children).reverse().forEach((n=>{var r;const o=e.querySelector(`#${n.id}`);if(o){if(null==(r=o.parentElement)?void 0:r.moveBefore)for(o.parentElement.moveBefore(n,o);o.hasChildNodes();)n.moveBefore(o.firstChild,null);else for(o.before(n);o.firstChild;)n.insertBefore(o.firstChild,null);!1!==t.callbacks.beforeNodeMorphed(n,o)&&(a(o,n,t),t.callbacks.afterNodeMorphed(n,o)),o.remove()}})),t.pantry.remove())}function E(e,t){return!e.deadIds.has(t)}function N(t,n,r){return(t.idMap.get(r)||e).has(n)}function S(t,n){let r=t.idMap.get(n)||e;for(const e of r)t.deadIds.add(e)}function k(t,n,r){let o=t.idMap.get(n)||e,i=0;for(const e of o)E(t,e)&&N(t,e,r)&&++i;return i}function M(e){let t=Array.from(e.querySelectorAll("[id]"));return e.id&&t.push(e),t}function x(e,t){let n=e.parentElement;for(const r of M(e)){let e=r;for(;e!==n&&null!=e;){let n=t.get(e);null==n&&(n=new Set,t.set(e,n)),n.add(r.id),e=e.parentElement}}}function T(e,t){let n=new Map;return x(e,n),x(t,n),n}function w(e,t){const n=e=>e.tagName+"#"+e.id,r=new Set(M(e).map(n));let o=new Set;for(const i of M(t))r.has(n(i))&&o.add(i.id);return o}return{morph:function(e,r,o={}){e instanceof Document&&(e=e.documentElement),"string"==typeof r&&(r=function(e){let t=new DOMParser,n=e.replace(/<svg(\s[^>]*>|>)([\s\S]*?)<\/svg>/gim,"");if(n.match(/<\/html>/)||n.match(/<\/head>/)||n.match(/<\/body>/)){let r=t.parseFromString(e,"text/html");if(n.match(/<\/html>/))return v.add(r),r;{let e=r.firstChild;return e?(v.add(e),e):null}}{let n=t.parseFromString("<body><template>"+e+"</template></body>","text/html").body.querySelector("template").content;return v.add(n),n}}(r));let i=function(e){if(null==e){return document.createElement("div")}if(v.has(e))return e;if(e instanceof Node){const t=document.createElement("div");return t.append(e),t}{const t=document.createElement("div");for(const n of[...e])t.append(n);return t}}(r),l=function(e,n,r){const o=function(e){let n=Object.assign({},t);return Object.assign(n,e),n.callbacks=Object.assign({},t.callbacks,e.callbacks),n.head=Object.assign({},t.head,e.head),n}(r);return{target:e,newContent:n,config:o,morphStyle:o.morphStyle,ignoreActive:o.ignoreActive,ignoreActiveValue:o.ignoreActiveValue,idMap:T(e,n),deadIds:new Set,persistentIds:o.twoPass?w(e,n):new Set,pantry:o.twoPass?d():document.createElement("div"),callbacks:o.callbacks,head:o.head}}(e,i,o);return n(e,i,l)},defaults:t}}();const _="CustomEvent"in window&&"function"==typeof window.CustomEvent?(e,t)=>new CustomEvent(e,t):(e,t)=>{const n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!0,!0,t),n},y=(e,t)=>function(n){const r=this,o=n.detail||{};e.__events[t].forEach((e=>{e.handler.apply(r,[n].concat(o.args))}))},A=(e,t)=>{e.__events[t]&&e.__events[t].listener&&(e.removeEventListener(t,e.__events[t].listener,"focus"==t||"blur"==t||"mouseenter"==t||"mouseleave"==t),delete e.__events[t])},E=(e,t,n)=>function(r){const o=this,i=r.detail||{};let l=r.target;for(;l&&(l.matches(t)&&(r.delegateTarget=l,n.apply(o,[r].concat(i.args))),l!==e);)l=l.parentNode},N=(e,t,n,r)=>{if(e.__events=e.__events||{},e.__events[t]=e.__events[t]||[],!e.__events[t].length){const n=y(e,t);e.addEventListener(t,n,"focus"==t||"blur"==t||"mouseenter"==t||"mouseleave"==t),e.__events[t].listener=n}n.call?e.__events[t].push({handler:n,callback:n}):e.__events[t].push({handler:E(e,n,r),callback:r})},S=(e,t,n)=>{if(n&&e.__events[t]&&e.__events[t].length){var r=e.__events[t];e.__events[t]=e.__events[t].filter((function(e){return e.callback!=n})),e.__events[t].listener=r.listener,e.__events[t].length||A(e,t)}else A(e,t)},k=(e,t,n)=>{e.dispatchEvent(_(t,{bubbles:!0,detail:n}))};const M=e=>({main:e=>e,unmount:e=>e,onupdate:e=>e,view:e.view?e.view:e=>e}),x=e=>{e.querySelectorAll("[scope]").forEach((e=>{e.querySelectorAll("[tplid]").forEach((t=>{if(!t.___scope___){const n=e.lastElementChild;t.___scope___="scope"in n.dataset?new Function(`return ${n.text}`)():{}}}))}))},T=e=>({callbacks:{beforeNodeMorphed(t){if(1===t.nodeType){if("html-static"in t.attributes)return!1;if(t.base&&t!==e)return!1}}}});function w(e,t,n,o){return class extends HTMLElement{constructor(){super();const{base:l,options:s}=function(e,{module:t,dependencies:n,templates:o,components:l}){const s=M(t),c=new Function(`return ${e.getAttribute("html-model")||"{}"}`)(),u=Object.keys(l).toString();f(e,u,o,l);const d=e.getAttribute("tplid"),m=d?o[d]:null,h={data:t.model?i(t.model):{}};h.data=Object.assign(h.data,c);const p={template:m,elm:e,dependencies:n,publish:b,subscribe:v,main(e){s.main=e},unmount(e){s.unmount=e},onupdate(e){s.onupdate=e},on(t,n,r){N(e,t,n,r)},off(t,n){S(e,t,n)},trigger(t,n,r){n.constructor===String?Array.from(e.querySelectorAll(n)).forEach((e=>k(e,t,{args:r}))):k(e,t,{args:n})},emit:(...t)=>{k(e,t.shift(),{args:t})},state:{set(e){if(e.constructor===Function){const t=i(h.data);e(t),p.render(t)}else p.render(e);return new Promise((e=>r((t=>r((()=>e(h.data)))))))},get:()=>i(h.data),getRaw:()=>h.data},render(t=h.data){if(!document.body.contains(e))return;h.data=Object.assign(h.data,t);const n=i(h.data),l=o[d].call(Object.assign(s.view(n),e.___scope___),e,a);g.morph(e,l,T(e)),x(e),r((n=>{Array.from(e.querySelectorAll("[tplid]")).forEach((e=>{const n=Object.assign(e.base.state.getRaw(),t);e.options.onupdate(n),e.base.render(n)}))}))},innerHTML(t,n){const o=n?t:e,i=o.cloneNode(),l=n||t;i.innerHTML=l,r((e=>g.morph(o,i,T)))}};return{base:p,options:s}}(this,{module:e,dependencies:t,templates:n,components:o});this.base=l,this.options=s,this.base.render(),this.returns=e.default(l)}connectedCallback(){if(this.__template&&this.__template.constructor===Promise)this.__template.then((e=>{if(this.base&&this.options.main){const e=this.options.main(this.base);e&&e.length&&e.forEach((e=>e(this.base)))}}));else if(this.returns&&this.returns.constructor===Promise)this.returns.then((e=>{if(this.base&&this.options.main){const e=this.options.main(this.base);e&&e.length&&e.forEach((e=>e(this.base)))}}));else if(this.base&&this.options.main){const e=this.options.main(this.base);e&&e.length&&e.forEach((e=>e(this.base)))}}disconnectedCallback(){this.options.unmount(this.base),r((()=>{document.body.contains(this)||(this.__events&&(this.__events=null),this.base&&(this.base.elm=null),this.base&&(this.base=null),l(this))}))}attributeChangedCallback(){}}}const $={},C={},H={templateConfig:e=>{Object.assign(u,e)},publish:b,subscribe:v,register(e,t,n={}){C[e]={name:e,module:t,dependencies:n}},start(e=document.body){const t=Object.keys(C),n=t.toString();t.length&&(f(e,n,$,C),L())}},L=()=>{Object.values(C).forEach((e=>{const{name:t,module:n,dependencies:r}=e;if(!customElements.get(t)){const e=w(n,r,$,C);customElements.define(t,e)}}))};e.attributes=e=>Object.entries(e).map((([e,t])=>""===t?e:`${e}="${t}"`)).join(" "),e.default=H,e.html=(e,...t)=>{let n=e.raw,r="";return t.forEach(((e,t)=>{let o=n[t];Array.isArray(e)&&(e=e.join("")),r+=o,r+=e})),r+=n[n.length-1],r},Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
//# sourceMappingURL=jails.js.map
