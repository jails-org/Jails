!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jails={})}(this,function(e){"use strict";var t=Object.defineProperty,n=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,i=(e,n,r)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[n]=r,a=(e,t)=>{for(var a in t||(t={}))r.call(t,a)&&i(e,a,t[a]);if(n)for(var a of n(t))o.call(t,a)&&i(e,a,t[a]);return e};let l;const s={scope:{}},c=e=>(l=l||document.createElement("textarea"),l.innerHTML=e,l.value),d=()=>Math.random().toString(36).substring(2,9),u=(e,t)=>{try{const n=e();return null!=n?n:t||""}catch(n){return t||""}},m={},f={},p=(e,t)=>{f[e]=b(t)?Object.assign({},f[e],t):t,m[e]&&m[e].forEach(e=>e(t))},h=(e,t)=>(m[e]=m[e]||[],m[e].push(t),e in f&&t(f[e]),()=>{m[e]=m[e].filter(e=>e!=t)}),b=e=>"object"==typeof e&&null!==e&&!Array.isArray(e);var v;var g="undefined"==typeof document?void 0:document,N=!!g&&"content"in g.createElement("template"),y=!!g&&g.createRange&&"createContextualFragment"in g.createRange();function A(e){return e=e.trim(),N?function(e){var t=g.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(e):y?function(e){return v||(v=g.createRange()).selectNode(g.body),v.createContextualFragment(e).childNodes[0]}(e):function(e){var t=g.createElement("body");return t.innerHTML=e,t.childNodes[0]}(e)}function E(e,t){var n,r,o=e.nodeName,i=t.nodeName;return o===i||(n=o.charCodeAt(0),r=i.charCodeAt(0),n<=90&&r>=97?o===i.toUpperCase():r<=90&&n>=97&&i===o.toUpperCase())}function T(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var _={OPTION:function(e,t){var n=e.parentNode;if(n){var r=n.nodeName.toUpperCase();"OPTGROUP"===r&&(r=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==r||n.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}T(e,t,"selected")},INPUT:function(e,t){T(e,t,"checked"),T(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var r=e.firstChild;if(r){var o=r.nodeValue;if(o==n||!n&&o==e.placeholder)return;r.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,r,o=-1,i=0,a=e.firstChild;a;)if("OPTGROUP"===(r=a.nodeName&&a.nodeName.toUpperCase()))(a=(n=a).firstChild)||(a=n.nextSibling,n=null);else{if("OPTION"===r){if(a.hasAttribute("selected")){o=i;break}i++}!(a=a.nextSibling)&&n&&(a=n.nextSibling,n=null)}e.selectedIndex=o}}};function C(){}function S(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}var $,O=($=function(e,t){var n,r,o,i,a=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var l=a.length-1;l>=0;l--)r=(n=a[l]).name,o=n.namespaceURI,i=n.value,o?(r=n.localName||r,e.getAttributeNS(o,r)!==i&&("xmlns"===n.prefix&&(r=n.name),e.setAttributeNS(o,r,i))):e.getAttribute(r)!==i&&e.setAttribute(r,i);for(var s=e.attributes,c=s.length-1;c>=0;c--)r=(n=s[c]).name,(o=n.namespaceURI)?(r=n.localName||r,t.hasAttributeNS(o,r)||e.removeAttributeNS(o,r)):t.hasAttribute(r)||e.removeAttribute(r)}},function(e,t,n){if(n||(n={}),"string"==typeof t)if("#document"===e.nodeName||"HTML"===e.nodeName||"BODY"===e.nodeName){var r=t;(t=g.createElement("html")).innerHTML=r}else t=A(t);else 11===t.nodeType&&(t=t.firstElementChild);var o=n.getNodeKey||S,i=n.onBeforeNodeAdded||C,a=n.onNodeAdded||C,l=n.onBeforeElUpdated||C,s=n.onElUpdated||C,c=n.onBeforeNodeDiscarded||C,d=n.onNodeDiscarded||C,u=n.onBeforeElChildrenUpdated||C,m=n.skipFromChildren||C,f=n.addChild||function(e,t){return e.appendChild(t)},p=!0===n.childrenOnly,h=Object.create(null),b=[];function v(e){b.push(e)}function N(e,t){if(1===e.nodeType)for(var n=e.firstChild;n;){var r=void 0;t&&(r=o(n))?v(r):(d(n),n.firstChild&&N(n,t)),n=n.nextSibling}}function y(e,t,n){!1!==c(e)&&(t&&t.removeChild(e),d(e),N(e,n))}function T(e){if(1===e.nodeType||11===e.nodeType)for(var t=e.firstChild;t;){var n=o(t);n&&(h[n]=t),T(t),t=t.nextSibling}}function O(e){a(e);for(var t=e.firstChild;t;){var n=t.nextSibling,r=o(t);if(r){var i=h[r];i&&E(t,i)?(t.parentNode.replaceChild(i,t),x(i,t)):O(t)}else O(t);t=n}}function x(e,t,n){var r=o(t);if(r&&delete h[r],!n){var a=l(e,t);if(!1===a)return;if(a instanceof HTMLElement&&T(e=a),$(e,t),s(e),!1===u(e,t))return}"TEXTAREA"!==e.nodeName?function(e,t){var n,r,a,l,s,c=m(e,t),d=t.firstChild,u=e.firstChild;e:for(;d;){for(l=d.nextSibling,n=o(d);!c&&u;){if(a=u.nextSibling,d.isSameNode&&d.isSameNode(u)){d=l,u=a;continue e}r=o(u);var p=u.nodeType,b=void 0;if(p===d.nodeType&&(1===p?(n?n!==r&&((s=h[n])?a===s?b=!1:(e.insertBefore(s,u),r?v(r):y(u,e,!0),r=o(u=s)):b=!1):r&&(b=!1),(b=!1!==b&&E(u,d))&&x(u,d)):3!==p&&8!=p||(b=!0,u.nodeValue!==d.nodeValue&&(u.nodeValue=d.nodeValue))),b){d=l,u=a;continue e}r?v(r):y(u,e,!0),u=a}if(n&&(s=h[n])&&E(s,d))c||f(e,s),x(s,d);else{var N=i(d);!1!==N&&(N&&(d=N),d.actualize&&(d=d.actualize(e.ownerDocument||g)),f(e,d),O(d))}d=l,u=a}!function(e,t,n){for(;t;){var r=t.nextSibling;(n=o(t))?v(n):y(t,e,!0),t=r}}(e,u,r);var A=_[e.nodeName];A&&A(e,t)}(e,t):_.TEXTAREA(e,t)}T(e);var w,j,L=e,M=L.nodeType,U=t.nodeType;if(!p)if(1===M)1===U?E(e,t)||(d(e),L=function(e,t){for(var n=e.firstChild;n;){var r=n.nextSibling;t.appendChild(n),n=r}return t}(e,(w=t.nodeName,(j=t.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==j?g.createElementNS(j,w):g.createElement(w)))):L=t;else if(3===M||8===M){if(U===M)return L.nodeValue!==t.nodeValue&&(L.nodeValue=t.nodeValue),L;L=t}if(L===t)d(e);else{if(t.isSameNode&&t.isSameNode(L))return;if(x(L,t,p),b)for(var k=0,P=b.length;k<P;k++){var H=h[b[k]];H&&y(H,H.parentNode,!1)}}return!p&&L!==e&&e.parentNode&&(L.actualize&&(L=L.actualize(e.ownerDocument||g)),e.parentNode.replaceChild(L,e)),L});const x=({name:e,module:t,dependencies:n,node:r,templates:o,signal:i,register:l})=>{var c;let d,m=[],f=null,b=[];const v=t.model||{},g=new Function(`return ${r.getAttribute("html-model")||"{}"}`)(),N=r.getAttribute("tplid"),y=r.getAttribute("html-scopeid"),A=o[N],E=s.scope[y],T=(_=(null==(c=null==t?void 0:t.model)?void 0:c.apply)?v({elm:r,initialState:g}):v,JSON.parse(JSON.stringify(_)));var _;const C=Object.assign({},E,T,g),S=t.view?t.view:e=>e,$={name:e,model:T,elm:r,template:A.template,dependencies:n,publish:p,subscribe:h,main(e){r.addEventListener(":mount",e)},state:{protected(e){if(!e)return m;m=e},save(e){e.constructor===Function?e(C):Object.assign(C,e)},set(e){if(!document.body.contains(r))return;e.constructor===Function?e(C):Object.assign(C,e);const t=Object.assign({},C,E);return new Promise(e=>{x(t,()=>e(t))})},get:()=>Object.assign({},C)},dataset(e,t){const n=t||e,o=(t?e:r).dataset[n];if("true"===o)return!0;if("false"===o)return!1;if(!isNaN(o)&&""!==o.trim())return Number(o);try{return new Function("return ("+o+")")()}catch(i){}try{return JSON.parse(o)}catch(i){}return o},on(e,t,n){const o=e.match(/\[(.*)\]/);if(o)return b.push({target:n?t:null,callback:n||t}),void(f||(f=new MutationObserver(e=>{for(const t of e)if("attributes"===t.type){const e=t.attributeName;e===o[1]&&b.forEach(n=>{(n.target?r.querySelectorAll(n.target):[r]).forEach(r=>{r==t.target&&n.callback({target:t.target,attribute:e,value:t.target.getAttribute(e)})})})}}),f.observe(r,{attributes:!0,subtree:!0}),r.addEventListener(":unmount",()=>{b=[],f.disconnect()})));n?(n.handler=e=>{const o=e.detail||{};let i=e.target;for(;i&&(i.matches(t)&&(e.delegateTarget=i,n.apply(r,[e].concat(o.args))),i!==r);)i=i.parentNode},r.addEventListener(e,n.handler,{signal:i,capture:"focus"==e||"blur"==e||"mouseenter"==e||"mouseleave"==e})):(t.handler=e=>{e.delegateTarget=r,t.apply(r,[e].concat(e.detail.args))},r.addEventListener(e,t.handler,{signal:i}))},off(e,t){t.handler&&r.removeEventListener(e,t.handler)},trigger(e,t,n){t.constructor===String?Array.from(r.querySelectorAll(t)).forEach(t=>{t.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{args:n}}))}):r.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{args:n}}))},emit(e,t){r.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{args:t}}))},unmount(e){r.addEventListener(":unmount",e)},innerHTML(e,t){const n=t?e:r,o=n.cloneNode(),i=t||e;o.innerHTML=i,O(n,o)}},x=(e,t=()=>{})=>{clearTimeout(d),d=setTimeout(()=>{const n=A.render.call(a(a({},e),S(e)),r,u,s);O(r,n,w(r,l)),Promise.resolve().then(()=>{r.querySelectorAll("[tplid]").forEach(t=>{const n=l.get(t);n&&(n.state.protected().forEach(t=>delete e[t]),n.state.set(e))}),Promise.resolve().then(()=>{s.scope={},t()})})})};return x(C),l.set(r,$),t.default($)},w=(e,t)=>{const n=n=>{if(1===n.nodeType){if("html-static"in n.attributes)return!1;if(t.get(n)&&n!==e)return!1}};return{onBeforeElChildrenUpdated:n,onBeforeElUpdated:n}},j=new WeakMap,L=({component:e,templates:t,start:n})=>{const{name:r,module:o,dependencies:i}=e;return class extends HTMLElement{constructor(){super()}connectedCallback(){this.abortController=new AbortController,this.getAttribute("tplid")||n(this.parentNode);const e=x({node:this,name:r,module:o,dependencies:i,templates:t,signal:this.abortController.signal,register:j});e&&e.constructor===Promise?e.then(()=>{this.dispatchEvent(new CustomEvent(":mount"))}):this.dispatchEvent(new CustomEvent(":mount"))}disconnectedCallback(){this.dispatchEvent(new CustomEvent(":unmount")),this.abortController.abort()}}},M={tags:["{{","}}"]},U={},k=/html-(allowfullscreen|async|autofocus|autoplay|checked|controls|default|defer|disabled|formnovalidate|inert|ismap|itemscope|loop|multiple|muted|nomodule|novalidate|open|playsinline|readonly|required|reversed|selected)="(.*?)"/g,P=/html-([^\s]*?)="(.*?)"/g,H=e=>{const t=JSON.stringify(e);return new Function("$element","safe","$g",`\n\t\tvar $data = this;\n\t\twith( $data ){\n\t\t\tvar output=${t.replace(/%%_=(.+?)_%%/g,function(e,t){return'"+safe(function(){return '+c(t)+';})+"'}).replace(/%%_(.+?)_%%/g,function(e,t){return'";'+c(t)+'\noutput+="'})};return output;\n\t\t}\n\t`)},R=(e,t,n)=>{const r=t.join(",");e.querySelectorAll(r).forEach(e=>{"template"!==e.localName?(e.hasAttribute("html-if")&&!e.id&&(e.id=d()),e.localName in n&&e.setAttribute("tplid",d())):R(e.content,t,n)})},B=e=>e.replace(/jails___scope-id/g,"%%_=$scopeid_%%").replace(new RegExp(`\\${M.tags[0]}(.+?)\\${M.tags[1]}`,"g"),"%%_=$1_%%").replace(k,"%%_if(safe(function(){ return $2 })){_%%$1%%_}_%%").replace(P,(e,t,n)=>["key","model","scopeid"].includes(t)?e:n?`${t}="%%_=safe(function(){ return ${n=n.replace(/^{|}$/g,"")} })_%%"`:e),V=e=>{e.querySelectorAll("template, [html-for], [html-if], [html-inner], [html-class]").forEach(e=>{const t=e.getAttribute("html-for"),n=e.getAttribute("html-if"),r=e.getAttribute("html-inner"),o=e.getAttribute("html-class");if(t){e.removeAttribute("html-for");const n=t.match(/(.*)\sin\s(.*)/)||"",r=n[1],o=n[2],i=o.split(/\./).shift(),a=document.createTextNode(`%%_ ;(function(){ var $index = 0; for(var $key in safe(function(){ return ${o} }) ){ var $scopeid = Math.random().toString(36).substring(2, 9); var ${r} = ${o}[$key]; $g.scope[$scopeid] = Object.assign({}, { ${i}: ${i} }, { ${r} :${r}, $index: $index, $key: $key }); _%%`),l=document.createTextNode("%%_ $index++; } })() _%%");F(a,e,l)}if(n){e.removeAttribute("html-if");const t=document.createTextNode(`%%_ if ( safe(function(){ return ${n} }) ){ _%%`),r=document.createTextNode("%%_ }  _%%");F(t,e,r)}r&&(e.removeAttribute("html-inner"),e.innerHTML=`%%_=${r}_%%`),o&&(e.removeAttribute("html-class"),e.className=(e.className+` %%_=${o}_%%`).trim()),"template"===e.localName&&V(e.content)})},I=(e,t)=>{Array.from(e.querySelectorAll("[tplid]")).reverse().forEach(e=>{const n=e.getAttribute("tplid"),r=e.localName;if(e.setAttribute("html-scopeid","jails___scope-id"),r in t&&t[r].module.template){const n=e.innerHTML,o=t[r].module.template({elm:e,children:n});e.innerHTML=o,V(e),q(e)}const o=B(e.outerHTML);U[n]={template:o,render:H(o)}})},q=e=>{e.querySelectorAll("template").forEach(e=>{if(e.getAttribute("html-if")||e.getAttribute("html-inner"))return;q(e.content);const t=e.parentNode;if(t){const n=e.content;for(;n.firstChild;)t.insertBefore(n.firstChild,e);t.removeChild(e)}})},F=(e,t,n)=>{var r,o;null==(r=t.parentNode)||r.insertBefore(e,t),null==(o=t.parentNode)||o.insertBefore(n,t.nextSibling)};globalThis.__jails__=globalThis.__jails__||{components:{}};const D=e=>{if("undefined"==typeof window)return;e=e||document.body;const{components:t}=globalThis.__jails__,n=((e,{components:t})=>{R(e,[...Object.keys(t),"[html-if]","template"],t);const n=e.cloneNode(!0);return V(n),q(n),I(n,t),U})(e,{components:t});Object.values(t).forEach(({name:e,module:t,dependencies:r})=>{customElements.get(e)||customElements.define(e,L({component:{name:e,module:t,dependencies:r},templates:n,start:D}))})};e.publish=p,e.register=(e,t,n)=>{const{components:r}=globalThis.__jails__;r[e]={name:e,module:t,dependencies:n}},e.start=D,e.subscribe=h,e.templateConfig=e=>{var t;t=e,Object.assign(M,t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=jails.js.map
