!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jails={})}(this,function(e){"use strict";var t,n=Object.defineProperty,r=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,a=(e,t,r)=>t in e?n(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,l=(e,t)=>{for(var n in t||(t={}))o.call(t,n)&&a(e,n,t[n]);if(r)for(var n of r(t))i.call(t,n)&&a(e,n,t[n]);return e};var s="undefined"==typeof document?void 0:document,c=!!s&&"content"in s.createElement("template"),d=!!s&&s.createRange&&"createContextualFragment"in s.createRange();function u(e){return e=e.trim(),c?function(e){var t=s.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(e):d?function(e){return t||(t=s.createRange()).selectNode(s.body),t.createContextualFragment(e).childNodes[0]}(e):function(e){var t=s.createElement("body");return t.innerHTML=e,t.childNodes[0]}(e)}function m(e,t){var n,r,o=e.nodeName,i=t.nodeName;return o===i||(n=o.charCodeAt(0),r=i.charCodeAt(0),n<=90&&r>=97?o===i.toUpperCase():r<=90&&n>=97&&i===o.toUpperCase())}function f(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var p={OPTION:function(e,t){var n=e.parentNode;if(n){var r=n.nodeName.toUpperCase();"OPTGROUP"===r&&(r=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==r||n.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}f(e,t,"selected")},INPUT:function(e,t){f(e,t,"checked"),f(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var r=e.firstChild;if(r){var o=r.nodeValue;if(o==n||!n&&o==e.placeholder)return;r.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,r,o=-1,i=0,a=e.firstChild;a;)if("OPTGROUP"===(r=a.nodeName&&a.nodeName.toUpperCase()))(a=(n=a).firstChild)||(a=n.nextSibling,n=null);else{if("OPTION"===r){if(a.hasAttribute("selected")){o=i;break}i++}!(a=a.nextSibling)&&n&&(a=n.nextSibling,n=null)}e.selectedIndex=o}}};function h(){}function b(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}var v,g=(v=function(e,t){var n,r,o,i,a=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var l=a.length-1;l>=0;l--)r=(n=a[l]).name,o=n.namespaceURI,i=n.value,o?(r=n.localName||r,e.getAttributeNS(o,r)!==i&&("xmlns"===n.prefix&&(r=n.name),e.setAttributeNS(o,r,i))):e.getAttribute(r)!==i&&e.setAttribute(r,i);for(var s=e.attributes,c=s.length-1;c>=0;c--)r=(n=s[c]).name,(o=n.namespaceURI)?(r=n.localName||r,t.hasAttributeNS(o,r)||e.removeAttributeNS(o,r)):t.hasAttribute(r)||e.removeAttribute(r)}},function(e,t,n){if(n||(n={}),"string"==typeof t)if("#document"===e.nodeName||"HTML"===e.nodeName||"BODY"===e.nodeName){var r=t;(t=s.createElement("html")).innerHTML=r}else t=u(t);else 11===t.nodeType&&(t=t.firstElementChild);var o=n.getNodeKey||b,i=n.onBeforeNodeAdded||h,a=n.onNodeAdded||h,l=n.onBeforeElUpdated||h,c=n.onElUpdated||h,d=n.onBeforeNodeDiscarded||h,f=n.onNodeDiscarded||h,g=n.onBeforeElChildrenUpdated||h,y=n.skipFromChildren||h,N=n.addChild||function(e,t){return e.appendChild(t)},A=!0===n.childrenOnly,E=Object.create(null),_=[];function T(e){_.push(e)}function C(e,t){if(1===e.nodeType)for(var n=e.firstChild;n;){var r=void 0;t&&(r=o(n))?T(r):(f(n),n.firstChild&&C(n,t)),n=n.nextSibling}}function S(e,t,n){!1!==d(e)&&(t&&t.removeChild(e),f(e),C(e,n))}function $(e){if(1===e.nodeType||11===e.nodeType)for(var t=e.firstChild;t;){var n=o(t);n&&(E[n]=t),$(t),t=t.nextSibling}}function O(e){a(e);for(var t=e.firstChild;t;){var n=t.nextSibling,r=o(t);if(r){var i=E[r];i&&m(t,i)?(t.parentNode.replaceChild(i,t),x(i,t)):O(t)}else O(t);t=n}}function x(e,t,n){var r=o(t);if(r&&delete E[r],!n){var a=l(e,t);if(!1===a)return;if(a instanceof HTMLElement&&$(e=a),v(e,t),c(e),!1===g(e,t))return}"TEXTAREA"!==e.nodeName?function(e,t){var n,r,a,l,c,d=y(e,t),u=t.firstChild,f=e.firstChild;e:for(;u;){for(l=u.nextSibling,n=o(u);!d&&f;){if(a=f.nextSibling,u.isSameNode&&u.isSameNode(f)){u=l,f=a;continue e}r=o(f);var h=f.nodeType,b=void 0;if(h===u.nodeType&&(1===h?(n?n!==r&&((c=E[n])?a===c?b=!1:(e.insertBefore(c,f),r?T(r):S(f,e,!0),r=o(f=c)):b=!1):r&&(b=!1),(b=!1!==b&&m(f,u))&&x(f,u)):3!==h&&8!=h||(b=!0,f.nodeValue!==u.nodeValue&&(f.nodeValue=u.nodeValue))),b){u=l,f=a;continue e}r?T(r):S(f,e,!0),f=a}if(n&&(c=E[n])&&m(c,u))d||N(e,c),x(c,u);else{var v=i(u);!1!==v&&(v&&(u=v),u.actualize&&(u=u.actualize(e.ownerDocument||s)),N(e,u),O(u))}u=l,f=a}!function(e,t,n){for(;t;){var r=t.nextSibling;(n=o(t))?T(n):S(t,e,!0),t=r}}(e,f,r);var g=p[e.nodeName];g&&g(e,t)}(e,t):p.TEXTAREA(e,t)}$(e);var w,j,L=e,M=L.nodeType,P=t.nodeType;if(!A)if(1===M)1===P?m(e,t)||(f(e),L=function(e,t){for(var n=e.firstChild;n;){var r=n.nextSibling;t.appendChild(n),n=r}return t}(e,(w=t.nodeName,(j=t.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==j?s.createElementNS(j,w):s.createElement(w)))):L=t;else if(3===M||8===M){if(P===M)return L.nodeValue!==t.nodeValue&&(L.nodeValue=t.nodeValue),L;L=t}if(L===t)f(e);else{if(t.isSameNode&&t.isSameNode(L))return;if(x(L,t,A),_)for(var U=0,k=_.length;U<k;U++){var H=E[_[U]];H&&S(H,H.parentNode,!1)}}return!A&&L!==e&&e.parentNode&&(L.actualize&&(L=L.actualize(e.ownerDocument||s)),e.parentNode.replaceChild(L,e)),L});let y;const N={scope:{}},A=e=>(y=y||document.createElement("textarea"),y.innerHTML=e,y.value),E=()=>Math.random().toString(36).substring(2,9),_=(e,t)=>{try{const n=e();return null!=n?n:t||""}catch(n){return t||""}},T={},C={},S=(e,t)=>{C[e]=O(t)?Object.assign({},C[e],t):t,T[e]&&T[e].forEach(e=>e(t))},$=(e,t)=>(T[e]=T[e]||[],T[e].push(t),e in C&&t(C[e]),()=>{T[e]=T[e].filter(e=>e!=t)}),O=e=>"object"==typeof e&&null!==e&&!Array.isArray(e),x=({name:e,module:t,dependencies:n,node:r,templates:o,signal:i,register:a})=>{var s;let c,d=[],u=null,m=[],f=null;const p=t.model||{},h=new Function(`return ${r.getAttribute("html-model")||"{}"}`)(),b=r.getAttribute("tplid"),v=r.getAttribute("html-scopeid"),y=o[b],A=N.scope[v],E=(T=(null==(s=null==t?void 0:t.model)?void 0:s.apply)?p({elm:r,initialState:h,dependencies:n}):p,JSON.parse(JSON.stringify(T)));var T;const C=Object.assign({},A,E,h),O=t.view?t.view:e=>e,x={name:e,model:E,elm:r,template:y.template,dependencies:n,publish:S,subscribe:$,main(e){r.addEventListener(":mount",e)},effect(e){if(!e)return f;f=e},query:e=>Array.from(r.querySelectorAll(e)).map(e=>new Promise((t,n)=>{document.body.contains(e)?e.addEventListener(":mount",()=>t(e)):n(e)})),state:{protected(e){if(!e)return d;d=e},save(e){e.constructor===Function?e(C):Object.assign(C,e)},set(e){if(!document.body.contains(r))return;e.constructor===Function?e(C):Object.assign(C,e);const t=Object.assign({},C,A);return new Promise(e=>{j(t,()=>e(t))})},get:()=>Object.assign({},C)},dataset(e,t){const n=t||e,o=(t?e:r).dataset[n];if("true"===o)return!0;if("false"===o)return!1;if(!isNaN(o)&&""!==o.trim())return Number(o);try{return new Function("return ("+o+")")()}catch(i){}try{return JSON.parse(o)}catch(i){}return o},on(e,t,n){const o=e.match(/\[(.*)\]/);if(o)return m.push({target:n?t:null,callback:n||t}),void(u||(u=new MutationObserver(e=>{for(const t of e)if("attributes"===t.type){const e=t.attributeName;e===o[1]&&m.forEach(n=>{(n.target?r.querySelectorAll(n.target):[r]).forEach(r=>{r==t.target&&n.callback({target:t.target,attribute:e,value:t.target.getAttribute(e)})})})}}),u.observe(r,{attributes:!0,subtree:!0}),r.addEventListener(":unmount",()=>{m=[],u.disconnect()})));n?(n.handler=e=>{const o=e.detail||{};let i=e.target;for(;i&&(i.matches(t)&&(e.delegateTarget=i,n.apply(r,[e].concat(o.args))),i!==r);)i=i.parentNode},r.addEventListener(e,n.handler,{signal:i,capture:"focus"==e||"blur"==e||"mouseenter"==e||"mouseleave"==e})):(t.handler=e=>{e.delegateTarget=r,t.apply(r,[e].concat(e.detail.args))},r.addEventListener(e,t.handler,{signal:i}))},off(e,t){t.handler&&r.removeEventListener(e,t.handler)},trigger(e,t,n={}){t.constructor===String?Array.from(r.querySelectorAll(t)).forEach(t=>{t.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{args:n}}))}):r.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{args:n}}))},emit(e,t){r.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{args:t}}))},unmount(e){r.addEventListener(":unmount",e)},innerHTML(e,t){const n=t?e:r,o=n.cloneNode(),i=t||e;o.innerHTML=i,g(n,o)}},j=(e,t=()=>{})=>{clearTimeout(c),c=setTimeout(()=>{const n=y.render.call(l(l({},e),O(e)),r,_,N);g(r,n,w(r,a)),Promise.resolve().then(()=>{r.querySelectorAll("[tplid]").forEach(t=>{const n=a.get(t),r=l({},n.__scope__);if(!n)return;n.state.protected().forEach(t=>delete e[t]);const o=n.effect();if(o){const t=o(e);t&&t.then?t.then(()=>n.state.set(l(l({},e),r))):n.state.set(l(l({},e),r))}else n.state.set(l(l({},e),r))}),Promise.resolve().then(()=>{N.scope={},t()})})})};return j(C),a.set(r,x),t.default(x)},w=(e,t,n)=>({getNodeKey(e){if(1===e.nodeType)return e.id||e.getAttribute("key")},onBeforeElUpdated:j(e,t),onBeforeChildElUpdated:j(e,t)}),j=(e,t,n)=>(n,r)=>{if(1===n.nodeType){if("html-static"in n.attributes)return!1;if(t.get(n)&&n!==e){const e=r.getAttribute("html-scopeid"),o=N.scope[e];return t.get(n).__scope__=o,!1}}},L=new WeakMap,M=({component:e,templates:t,start:n})=>{const{name:r,module:o,dependencies:i}=e;return class extends HTMLElement{constructor(){super()}connectedCallback(){this.abortController=new AbortController,this.getAttribute("tplid")||n(this.parentNode);const e=x({node:this,name:r,module:o,dependencies:i,templates:t,signal:this.abortController.signal,register:L});e&&e.constructor===Promise?e.then(()=>{this.dispatchEvent(new CustomEvent(":mount"))}):this.dispatchEvent(new CustomEvent(":mount"))}disconnectedCallback(){this.dispatchEvent(new CustomEvent(":unmount")),this.abortController.abort()}}},P={tags:["{{","}}"]},U={},k=/html-(allowfullscreen|async|autofocus|autoplay|checked|controls|default|defer|disabled|formnovalidate|inert|ismap|itemscope|loop|multiple|muted|nomodule|novalidate|open|playsinline|readonly|required|reversed|selected)="(.*?)"/g,H=/html-([^\s]*?)="(.*?)"/g,R=e=>{const t=JSON.stringify(e);return new Function("$element","safe","$g",`\n\t\tvar $data = this;\n\t\twith( $data ){\n\t\t\tvar output=${t.replace(/%%_=(.+?)_%%/g,function(e,t){return'"+safe(function(){return '+A(t)+';})+"'}).replace(/%%_(.+?)_%%/g,function(e,t){return'";'+A(t)+'\noutput+="'})};return output;\n\t\t}\n\t`)},B=(e,t,n)=>{const r=t.join(",");e.querySelectorAll(r).forEach(e=>{"template"!==e.localName?(e.hasAttribute("html-if")&&!e.id&&(e.id=E()),e.localName in n&&e.setAttribute("tplid",E())):B(e.content,t,n)})},q=e=>e.replace(/jails___scope-id/g,"%%_=$scopeid_%%").replace(new RegExp(`\\${P.tags[0]}(.+?)\\${P.tags[1]}`,"g"),"%%_=$1_%%").replace(k,"%%_if(safe(function(){ return $2 })){_%%$1%%_}_%%").replace(H,(e,t,n)=>["model","scopeid"].includes(t)?e:n?`${t}="%%_=safe(function(){ return ${n=n.replace(/^{|}$/g,"")} })_%%"`:e),V=e=>{e.querySelectorAll("template, [html-for], [html-if], [html-inner], [html-class]").forEach(e=>{const t=e.getAttribute("html-for"),n=e.getAttribute("html-if"),r=e.getAttribute("html-inner"),o=e.getAttribute("html-class");if(t){e.removeAttribute("html-for");const n=t.match(/(.*)\sin\s(.*)/)||"",r=n[1],o=n[2],i=o.split(/\./).shift(),a=document.createTextNode(`%%_ ;(function(){ var $index = 0; for(var $key in safe(function(){ return ${o} }) ){ var $scopeid = Math.random().toString(36).substring(2, 9); var ${r} = ${o}[$key]; $g.scope[$scopeid] = Object.assign({}, { ${i}: ${i} }, { ${r} :${r}, $index: $index, $key: $key }); _%%`),l=document.createTextNode("%%_ $index++; } })() _%%");D(a,e,l)}if(n){e.removeAttribute("html-if");const t=document.createTextNode(`%%_ if ( safe(function(){ return ${n} }) ){ _%%`),r=document.createTextNode("%%_ }  _%%");D(t,e,r)}r&&(e.removeAttribute("html-inner"),e.innerHTML=`%%_=${r}_%%`),o&&(e.removeAttribute("html-class"),e.className=(e.className+` %%_=${o}_%%`).trim()),"template"===e.localName&&V(e.content)})},I=(e,t)=>{Array.from(e.querySelectorAll("[tplid]")).reverse().forEach(e=>{const n=e.getAttribute("tplid"),r=e.localName;if(e.setAttribute("html-scopeid","jails___scope-id"),r in t&&t[r].module.template){const n=e.innerHTML,o=t[r].module.template({elm:e,children:n});e.innerHTML=o,V(e),F(e)}const o=q(e.outerHTML);U[n]={template:o,render:R(o)}})},F=e=>{e.querySelectorAll("template").forEach(e=>{if(e.getAttribute("html-if")||e.getAttribute("html-inner"))return;F(e.content);const t=e.parentNode;if(t){const n=e.content;for(;n.firstChild;)t.insertBefore(n.firstChild,e);t.removeChild(e)}})},D=(e,t,n)=>{var r,o;null==(r=t.parentNode)||r.insertBefore(e,t),null==(o=t.parentNode)||o.insertBefore(n,t.nextSibling)};globalThis.__jails__=globalThis.__jails__||{components:{}};const z=e=>{if("undefined"==typeof window)return;e=e||document.body;const{components:t}=globalThis.__jails__,n=((e,{components:t})=>{B(e,[...Object.keys(t),"[html-if]","template"],t);const n=e.cloneNode(!0);return V(n),F(n),I(n,t),U})(e,{components:t});Object.values(t).forEach(({name:e,module:t,dependencies:r})=>{customElements.get(e)||customElements.define(e,M({component:{name:e,module:t,dependencies:r},templates:n,start:z}))})};e.publish=S,e.register=(e,t,n)=>{const{components:r}=globalThis.__jails__;r[e]={name:e,module:t,dependencies:n}},e.start=z,e.subscribe=$,e.templateConfig=e=>{var t;t=e,Object.assign(P,t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=jails.js.map
